# [ä½¿ç”¨CI/CDå·¥å…·Github Actionå‘å¸ƒjaråˆ°Mavenä¸­å¤®ä»“åº“](https://segmentfault.com/a/1190000039716048)

[![](assets/1624344755-6dcf08306d3bfb2275d64dbbf7b86881.webp)**ç å†œå°èƒ–å“¥**](https://segmentfault.com/u/10000000)å‘å¸ƒäº 3 æœˆ 26 æ—¥

ä¹‹å‰å‘å¸ƒå¼€æºé¡¹ç›®[Payment Spring Boot](https://github.com/NotFound403/payment-spring-boot)åˆ°Mavenä¸­å¤®ä»“åº“æˆ‘éƒ½æ˜¯æ‰‹åŠ¨æ‰§è¡Œ`mvn deploy`ï¼Œåœ¨**CI/CD**å¤§è¡Œå…¶é“çš„ä»Šå¤©ä½¿ç”¨è¿™ç§æ–¹å¼æœ‰ç‚¹â€œåŸå§‹â€ã€‚äºæ˜¯æˆ‘ä¸€ç›´åœ¨å¯»æ±‚ä¸€ç§èƒ½å¤Ÿæ”¯æŒæµæ°´çº¿ä½œä¸šçš„å‘å¸ƒå·¥å…·ï¼Œèƒ½è®©æˆ‘åœ¨è¿›è¡Œåˆå¹¶ä»£ç æ—¶è‡ªåŠ¨è§¦å‘æ„å»ºå‘å¸ƒã€‚æœ‰ä¸€æ¬¾å…è´¹çš„äº§å“èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œå®ƒå°±æ˜¯**Github Action**ã€‚

## Github Action

**Github Action**æ˜¯ç”±Githubåˆ›å»ºçš„**CI/CD**æœåŠ¡ã€‚ å®ƒçš„ç›®çš„æ˜¯ä½¿æ‰€æœ‰è½¯ä»¶å¼€å‘å·¥ä½œæµç¨‹çš„è‡ªåŠ¨åŒ–å˜å¾—å®¹æ˜“ã€‚ ç›´æ¥ä»GitHubæ„å»ºï¼Œæµ‹è¯•å’Œéƒ¨ç½²ä»£ç ã€‚CIï¼ˆæŒç»­é›†æˆï¼‰ç”±å¾ˆå¤šæ“ä½œç»„æˆï¼Œæ¯”å¦‚ä»£ç åˆå¹¶ã€è¿è¡Œæµ‹è¯•ã€ç™»å½•è¿œç¨‹æœåŠ¡å™¨ï¼Œå‘å¸ƒåˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰ç­‰ã€‚

ä»Šå¤©æˆ‘å°±å°è¯•ç”¨**Github Action**æ¥å°†[Payment Spring Boot](https://github.com/NotFound403/payment-spring-boot)å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“ã€‚

## æœŸæœ›æ•ˆæœ

å½“ä»£ç åº“å‘å¸ƒ**Release(å‘è¡Œç‰ˆ)**çš„æ—¶å€™è§¦å‘ä¸€ä¸ªå°†**Release**æ‰€åŒ…å«çš„åˆ†æ”¯å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“çš„æ•ˆæœã€‚

![Githubä¸­çš„Releaseå‘è¡Œç‰ˆ](assets/1624344755-3cb371466178e2823a301a922bf91cce.webp "Githubä¸­çš„Releaseå‘è¡Œç‰ˆ")

> æ‹“å±•é˜…è¯»ï¼š
> 
> `Releaseï¼ˆå‘è¡Œç‰ˆï¼‰`æ˜¯å…·æœ‰ `Changelogs`ï¼ˆå˜æ›´æ—¥å¿—ï¼‰å’ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸€çº§å¯¹è±¡ï¼Œå¯ä»¥ä»£è¡¨è¶…å‡º Git æ¶æ„æœ¬èº«çš„ä¸€ä¸ªç‰¹å®šæ—¶é—´ç‚¹ä¹‹å‰çš„æ‰€æœ‰é¡¹ç›®å†å²ã€‚

## å‰ææ¡ä»¶

å…³äºé¡¹ç›®å¦‚ä½•å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“åŠå…¶ä¸€äº›å¿…è¦çš„æ¡ä»¶è¿™é‡Œä¸å†è®¨è®ºï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»æœç´¢ä¸€ä¸‹ã€‚ä¹Ÿå¯ä»¥å‚è€ƒ[Payment Spring Boot](https://github.com/NotFound403/payment-spring-boot)çš„`pom.xml`ã€‚è¿™é‡Œåªè¯´ä¸€äº›å…³é”®çš„ç‚¹ï¼Œæ‚¨éœ€è¦ï¼š

*   OSSRHè´¦å·ã€‚
*   GPGå¯†é’¥ä¿¡æ¯ã€‚

> ğŸ’¡æ³¨æ„ï¼šè¿™ä¸¤ä¸ªéƒ½æ˜¯æ•æ„Ÿæ•°æ®ä¸è¦æ³„éœ²ç»™å…¶ä»–äººï¼Œå¦åˆ™ä½ çš„é¡¹ç›®å°†å¯èƒ½è¢«å…¶ä»–äººæŒæ§ã€‚

## Github Action Secrets

ä¸ºäº†ä»**Github Action**å‘å¸ƒï¼Œæˆ‘ä»¬éœ€è¦è®©**Github Action**å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„GPGç§é’¥å’ŒOSSRHç”¨æˆ·ä¿¡æ¯ã€‚ä¸ºäº†ä¿è¯è¿™äº›æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[Github Action Secrets](https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets)æ¥å­˜å‚¨å®ƒä»¬ã€‚

### GPGçš„ç»†èŠ‚è¡¥å……

è¿™é‡Œçš„ `GPG_PASSWORD`ä¸º**GPG**çš„ `Passphrase`,ç½‘ä¸ŠMavenä¸­å¤®ä»“åº“æ•™ç¨‹è‚¯å®šä¼šæè¿™ä¸ªï¼Œè¿™é‡Œä¸å†ç»†è¯´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å…¬é’¥ä¸€å®šè¦ä¸Šä¼ å…¬é’¥æœåŠ¡å™¨ã€‚

`GPG_SECRET` è·å–æ­¥éª¤å¦‚ä¸‹ï¼š

*   ç¡®å®šä½ æœ‰GPGç¯å¢ƒï¼Œå¹¶æŒ‰ç…§å…¶å®ƒæ•™ç¨‹é…ç½®å¥½äº†GPGå¯†é’¥å¯¹ã€‚
*   æ‰§è¡Œ `gpg --list-secret-keys` æŸ¥çœ‹Keyåˆ—è¡¨å¹¶å¤åˆ¶**ä½ éœ€è¦ç”¨çš„ID**

```shell
[root@192 ~]# gpg --list-secret-keys
/root/.gnupg/pubring.kbx
------------------------
sec   rsa2048 2020-07-27 [SC]
      8AC0AB86C34ADC6ED110A5A9E6730F4374866065
uid           felord (felord) <dax@felord.cn>
```

*   æ‰§è¡Œ`gpg -a --export-secret-keys KEY_ID`(`KEY_ID`ä¸ºä¸Šå›¾ä¸­ä»¥`8AC0AB`å¼€å¤´çš„å­—ç¬¦ä¸²)å¯¼å‡ºç§é’¥ï¼Œè¿™é‡Œéœ€è¦è¾“å…¥ä¿æŠ¤ç§é’¥çš„å¯†ç ï¼ˆ`GPG_PASSWORD`ï¼‰ã€‚ç„¶åä¼šå‡ºç°ä»¥ä¸‹çš„å¯†æ–‡ï¼š

```plain
-----BEGIN PGP PRIVATE KEY BLOCK----
............å¯†æ–‡åŒºåŸŸ.............
-----END PGP PRIVATE KEY BLOCK-----
```

è¿™å°±æ˜¯`` `GPG_SECRET`` \`ã€‚

## ä¿®æ”¹é¡¹ç›®çš„POM

ç„¶åä¿®æ”¹é¡¹ç›®çš„`pom.xml`æ–‡ä»¶ï¼Œæ¨¡æ¿æˆ‘å·²ç»æå‡ºæ¥äº†ï¼Œä¸èƒ½ä¿®æ”¹çš„åœ°æ–¹æˆ‘å·²ç»å†™äº†æ³¨é‡Šï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <groupId>cn.felord</groupId>
    <artifactId>payment-spring-boot</artifactId>
    <version>1.0.9.RELEASE</version>
    <packaging>pom</packaging>
    <modelVersion>4.0.0</modelVersion>

    <name>payment-spring-boot</name>
    <description>wechat-pay and alipay sdk</description>
    <url>https://github.com/NotFound403/payment-spring-boot</url>

    <licenses>
        <license>
            <name>Apache License, Version 2.0</name>
            <url>https://www.apache.org/licenses/LICENSE-2.0.txt</url>
            <distribution>repo</distribution>
            <comments>A business-friendly OSS license</comments>
        </license>
    </licenses>

    <developers>
        <developer>
            <name>felord</name>
            <email>felord@qq.com</email>
            <organization>felord.cn</organization>
        </developer>
    </developers>

    <scm>
        <tag>payment-spring-boot-1.0.9.RELEASE</tag>
        <url>https://github.com/NotFound403/payment-spring-boot</url>
        <connection>scm:git:https://github.com/NotFound403/payment-spring-boot.git</connection>
        <developerConnection>scm:git:https://github.com/NotFound403/payment-spring-boot.git</developerConnection>
    </scm>

    <profiles>
        <!-- Deployment profile (required so these plugins are only used when deploying) -->
         <!-- ä¸‹é¢è¿™ä¸ªæ ‡ç­¾é‡Œçš„ä¸èƒ½æ”¹ -->
        <profile>
            <id>deploy</id>
            <build>
                <plugins>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-source-plugin</artifactId>
                    </plugin>
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-javadoc-plugin</artifactId>
                    </plugin>
                    <!-- GPG plugin -->
                    <plugin>
                        <groupId>org.apache.maven.plugins</groupId>
                        <artifactId>maven-gpg-plugin</artifactId>
                    </plugin>
                </plugins>
            </build>
        </profile>
    </profiles>

    <modules>
        <module>payment-spring-boot-autoconfigure</module>
        <module>payment-spring-boot-starter</module>
    </modules>

    <properties>
        <maven.compiler.source>1.8</maven.compiler.source>
        <maven.compiler.target>1.8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <java.version>1.8</java.version>
        <spring-boot.version>2.4.2</spring-boot.version>
        <aliy-pay-sdk.version>4.10.167.ALL</aliy-pay-sdk.version>
        <oss-starter.version>1.0.0.RELEASE</oss-starter.version>
        <lombok.verison>1.18.12</lombok.verison>
        <jackson.version>2.9.10</jackson.version>
        <bcprov.version>1.66</bcprov.version>
        <jackson.version>2.11.4</jackson.version>
        <httpclient.version>4.5.13</httpclient.version>
    </properties>

    <!-- ä¸‹é¢è¿™ä¸ªæ ‡ç­¾é‡Œçš„ä¸èƒ½æ”¹ -->
    <distributionManagement>
        <repository>
            <id>ossrh</id>
            <name>Nexus Release Repository</name>
            <url>https://oss.sonatype.org/service/local/staging/deploy/maven2</url>
        </repository>
        <snapshotRepository>
            <id>sonatype-nexus-snapshots</id>
            <name>Nexus Snapshot Repository</name>
            <url>https://oss.sonatype.org/content/repositories/snapshots</url>
        </snapshotRepository>
    </distributionManagement>

    <dependencyManagement>
        <dependencies>
            <!-- ä½ é¡¹ç›®çš„ä¾èµ–å†™è¿™é‡Œ-->
        </dependencies>
    </dependencyManagement>
         <!-- ä¸‹é¢è¿™ä¸ªæ ‡ç­¾é‡Œçš„ä¸èƒ½æ”¹ -->
    <build>
        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-source-plugin</artifactId>
                    <version>3.1.0</version>
                    <executions>
                        <execution>
                            <phase>package</phase>
                            <goals>
                                <goal>jar-no-fork</goal>
                            </goals>
                        </execution>
                    </executions>
                </plugin>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-javadoc-plugin</artifactId>
                    <version>3.2.0</version>
                    <configuration>
                        <show>private</show>
                        <nohelp>true</nohelp>
                        <charset>UTF-8</charset>
                        <encoding>UTF-8</encoding>
                        <docencoding>UTF-8</docencoding>
                    </configuration>
                    <executions>
                        <execution>
                            <phase>compile</phase>
                            <goals>
                                <goal>jar</goal>
                            </goals>
                        </execution>
                    </executions>
                </plugin>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-gpg-plugin</artifactId>
                    <version>1.6</version>
                    <executions>
                        <execution>
                            <id>sign-artifacts</id>
                            <phase>verify</phase>
                            <goals>
                                <goal>sign</goal>
                            </goals>
                            <configuration>
                                <!-- Prevent `gpg` from using pinentry programs -->
                                <gpgArguments>
                                    <arg>--pinentry-mode</arg>
                                    <arg>loopback</arg>
                                </gpgArguments>
                            </configuration>
                        </execution>
                    </executions>
                </plugin>
                <plugin>
                    <groupId>org.sonatype.plugins</groupId>
                    <artifactId>nexus-staging-maven-plugin</artifactId>
                    <version>1.6.8</version>
                    <extensions>true</extensions>
                    <configuration>
                        <serverId>ossrh</serverId>
                        <nexusUrl>https://oss.sonatype.org/</nexusUrl>
                        <autoReleaseAfterClose>false</autoReleaseAfterClose>
                    </configuration>
                </plugin>
            </plugins>
        </pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.sonatype.plugins</groupId>
                <artifactId>nexus-staging-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

> ç»“åˆä½ è‡ªå·±çš„é¡¹ç›®è¿›è¡Œå¿…è¦çš„å¡«å……ã€‚

## ç¼–å†™Github Action è„šæœ¬

`Github Action`è„šæœ¬ä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„`.github/workflows`è·¯å¾„ä¸­ã€‚æˆ‘ä»¬åªéœ€è¦ç¼–å†™ä¸€ä¸ª`yaml`æ¥å£°æ˜æ‰§è¡Œçš„æ­¥éª¤å³å¯ï¼Œå…·ä½“çš„è¯­æ³•å¯ä»¥å»çœ‹ç›¸å…³çš„ä¸­æ–‡æ–‡æ¡£ï¼Œè¿™é‡Œåªåˆ—å‡ºå‘å¸ƒåˆ°**Maven**ä¸­å¤®ä»“åº“çš„actionè„šæœ¬ï¼š

```yaml
# ç›¸å½“äºè„šæœ¬ç”¨é€”çš„ä¸€ä¸ªå£°æ˜
name: Maven Central Repo Deployment
# è§¦å‘è„šæœ¬çš„äº‹ä»¶  è¿™é‡Œä¸ºå‘å¸ƒreleaseä¹‹åè§¦å‘
on:
  release:
    types: [released]
# å®šä¹‰ä¸€ä¸ªå‘è¡Œä»»åŠ¡
jobs:
  publish:
# ä»»åŠ¡è¿è¡Œçš„ç¯å¢ƒ
    runs-on: ubuntu-latest
# ä»»åŠ¡çš„æ­¥éª¤
    steps:
# 1. å£°æ˜ checkout ä»“åº“ä»£ç åˆ°å·¥ä½œåŒº
      - name: Checkout Git Repo
        uses: actions/checkout@v2
# 2. å®‰è£…Java ç¯å¢ƒ è¿™é‡Œä¼šç”¨åˆ°çš„å‚æ•°å°±æ˜¯ Git Action secretsä¸­é…ç½®çš„ï¼Œ
#    å–å€¼è¦åœ¨keyå‰é¢åŠ   secrets.
      - name: Set up Maven Central Repo
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
          server-id: sonatype-nexus-staging
          server-username: ${{ secrets.OSSRH_USER }}
          server-password: ${{ secrets.OSSRH_PASSWORD }}
          gpg-passphrase:  ${{ secrets.GPG_PASSWORD }}
# 3. å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“
      - name: Publish to Maven Central Repo
# è¿™é‡Œç”¨åˆ°äº†å…¶ä»–äººå†™çš„actionè„šæœ¬ï¼Œè¯¦ç»†å¯ä»¥å»çœ‹ä»–çš„æ–‡æ¡£ã€‚
        uses: samuelmeuli/action-maven-publish@v1
        with:
          gpg_private_key: ${{ secrets.GPG_SECRET }}
          gpg_passphrase: ${{ secrets.GPG_PASSWORD }}
          nexus_username: ${{ secrets.OSSRH_USER }}
          nexus_password: ${{ secrets.OSSRH_PASSWORD }}
```

## è§¦å‘Action

éƒ½å‡†å¤‡å®Œæ¯•åï¼Œactionè„šæœ¬è¦æäº¤åˆ°**Github**ï¼Œå½“ä½ ä½¿ç”¨`release`åŠŸèƒ½åä¼šè‡ªåŠ¨åœ¨`action`ä¸€æ ä¸­æ‰§è¡Œæ•´ä¸ªå‘å¸ƒæµç¨‹ï¼š

![è‡ªåŠ¨å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“](assets/1624344755-e66879dd8fcb3b9757f684e3209a7493.webp "è‡ªåŠ¨å‘å¸ƒåˆ°Mavenä¸­å¤®ä»“åº“")

è¿™ç§æ–¹å¼ä¸€æ¬¡é…ç½®ï¼Œåˆ°å¤„å‘å¸ƒã€‚æˆ‘ä»¬ä¸éœ€è¦å†å…³å¿ƒæ€ä¹ˆå‘å¸ƒäº†ï¼Œåªéœ€è¦å…³å¿ƒåœ¨ä»€ä¹ˆæ—¶å€™å‘å¸ƒã€‚

> å¯ä»¥å‚è€ƒ **Payment Spring Boot**é¡¹ç›®ã€‚

## æ€»ç»“

ä»Šå¤©é€šè¿‡å¯¹**Github Action**çš„ç®€å•ä½¿ç”¨æ¥ä»‹ç»äº†**CI/CD**çš„ä½œç”¨ï¼Œè¿™ä¸ªæŠ€æœ¯ä½“ç³»æ˜¯é¡¹ç›®é›†æˆäº¤ä»˜çš„è¶‹åŠ¿ï¼Œä¹Ÿæ˜¯é¢è¯•ä¸­çš„ä¸€ä¸ªäº®ç‚¹æŠ€èƒ½ã€‚ è€Œä¸”è¿™ç§æ–¹å¼å¯ä»¥å®ç°â€œä¸€æ¬¡é…ç½®ï¼Œéšæ—¶éšåœ°é›†æˆéƒ¨ç½²â€ã€‚

`å…³æ³¨å…¬ä¼—å·ï¼šFelordcn è·å–æ›´å¤šèµ„è®¯`

[ä¸ªäººåšå®¢ï¼šhttps://felord.cn](https://felord.cn/)

[java](https://segmentfault.com/t/java)

é˜…è¯» 286å‘å¸ƒäº 3 æœˆ 26 æ—¥

èµæ”¶è—

[åˆ†äº«](###)

æœ¬ä½œå“ç³»åŸåˆ›ï¼Œ[é‡‡ç”¨ã€Šç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…ã€‹è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-nd/4.0/)

